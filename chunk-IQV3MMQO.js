import{b as Ee,c as ye,d as Ie,e as be,f as A,g as Te,i as Fe,j as we,k as b,l as Ue,m as je,n as Ce,o as O,p as _}from"./chunk-6MNVWFTH.js";import{$b as Ae,Ca as f,Cb as Se,D as l,Da as c,Ea as y,F as h,G as m,H as a,J as ne,Ja as K,Lb as S,Na as ue,Oc as De,Pc as Pe,Qb as ve,Rb as R,T as ae,Tb as ke,U as ce,Ub as T,Va as g,Wb as Me,Xb as Ne,Zb as Re,_a as de,a as Q,ab as N,ac as Oe,b as w,bc as _e,c as U,cc as xe,dc as $e,f as j,g as C,h as I,ha as fe,ia as p,j as V,ja as E,k as G,l as H,m as k,n as M,nb as me,o as J,p as ee,q as te,r as re,rb as pe,t as ie,ta as z,tb as he,u as q,v as oe,va as u,y as se,yb as ge,z as Y,za as le,zc as Be}from"./chunk-CX4LBOHC.js";import{a as F,f as L}from"./chunk-CWTPBX7D.js";var Le=(()=>{let r=class r{constructor(){this._isUsedByNgShop$=new U(!1),this.isUsedByNgShop$=this._isUsedByNgShop$.asObservable()}setIsUsedByNgShop(){this._isUsedByNgShop$.next(!0)}};r.\u0275fac=function(i){return new(i||r)},r.\u0275prov=l({token:r,factory:r.\u0275fac,providedIn:"root"});let e=r;return e})();var v=(()=>{let r=class r{constructor(t,i){this.http=t,this.usersFacade=i,this._loggedInUser$=new U(this.getToken()),this.loggedInUser$=this._loggedInUser$.asObservable(),this.apiUrl=R.API_URL}checkProdMode(){console.log("environment",R),console.log("isDevMode",me()),R.production&&void 0}login({email:t,password:i}){return this.http.post(`${this.apiUrl}users/login`,{email:t,password:i})}logout(){localStorage.removeItem("jwtToken"),this._loggedInUser$.next(null)}logoutNgShop(){this.usersFacade.userSessionLogout()}loginNgShop(t){this.usersFacade.userSessionLogin(t)}saveTokenAdminPanel(t){return JSON.parse(atob(t.split(".")[1])).isAdmin?(localStorage.setItem("jwtToken",t),this._loggedInUser$.next(t),!0):!1}saveTokenNgShop(t){let i=atob(t.split(".")[1]),o=JSON.parse(i);this.isTokenExpried(o.exp)||localStorage.setItem("jwtToken",t)}getToken(){return localStorage.getItem("jwtToken")}getUserIdFromToken(){let t=this.getToken();if(t){let i=JSON.parse(atob(t.split(".")[1]));return i?i.userId:null}return null}isValidToken(){let t=this.getToken();if(t){let i=JSON.parse(atob(t.split(".")[1]));return!this.isTokenExpried(i)}else return!1}isTokenExpried(t){return Math.floor(new Date().getTime()/1e3)>=t}get loggedInUser(){return this._loggedInUser$.value}};r.\u0275fac=function(i){return new(i||r)(m(Se),m(O))},r.\u0275prov=l({token:r,factory:r.\u0275fac,providedIn:"root"});let e=r;return e})();var Qe={dispatch:!0,functional:!1,useEffectsErrorHandler:!0},$="__@ngrx/effects_create__";function B(e,r={}){let s=r.functional?e:e(),t=F(F({},Qe),r);return Object.defineProperty(s,$,{value:t}),s}function et(e){return Object.getOwnPropertyNames(e).filter(t=>e[t]&&e[t].hasOwnProperty($)?e[t][$].hasOwnProperty("dispatch"):!1).map(t=>{let i=e[t][$];return F({propertyName:t},i)})}function tt(e){return et(e)}function Ve(e){return Object.getPrototypeOf(e)}function rt(e){return!!e.constructor&&e.constructor.name!=="Object"&&e.constructor.name!=="Function"}function Ge(e){return typeof e=="function"}function it(e){return e.filter(Ge)}function ot(e,r,s){let t=Ve(e),o=!!t&&t.constructor.name!=="Object"?t.constructor.name:null,n=tt(e).map(({propertyName:d,dispatch:P,useEffectsErrorHandler:Xe})=>{let X=typeof e[d]=="function"?e[d]():e[d],Z=Xe?s(X,r):X;return P===!1?Z.pipe(te()):Z.pipe(oe()).pipe(I(Ze=>({effect:e[d],notification:Ze,propertyName:d,sourceName:o,sourceInstance:e})))});return H(...n)}var st=10;function He(e,r,s=st){return e.pipe(M(t=>(r&&r.handleError(t),s<=1?e:He(e,r,s-1))))}var Je=(()=>{let r=class r extends Q{constructor(t){super(),t&&(this.source=t)}lift(t){let i=new r;return i.source=this,i.operator=t,i}};r.\u0275fac=function(i){return new(i||r)(m(be))},r.\u0275prov=l({token:r,factory:r.\u0275fac,providedIn:"root"});let e=r;return e})();function D(...e){return k(r=>e.some(s=>typeof s=="string"?s===r.type:s.type===r.type))}var er=new h("@ngrx/effects Internal Root Guard"),tr=new h("@ngrx/effects User Provided Effects"),rr=new h("@ngrx/effects Internal Root Effects"),ir=new h("@ngrx/effects Internal Root Effects Instances"),or=new h("@ngrx/effects Internal Feature Effects"),sr=new h("@ngrx/effects Internal Feature Effects Instance Groups"),nt=new h("@ngrx/effects Effects Error Handler",{providedIn:"root",factory:()=>He}),at="@ngrx/effects/init",ct=Ee(at);function ft(e,r){if(e.notification.kind==="N"){let s=e.notification.value;!lt(s)&&r.handleError(new Error(`Effect ${ut(e)} dispatched an invalid action: ${dt(s)}`))}}function lt(e){return typeof e!="function"&&e&&e.type&&typeof e.type=="string"}function ut({propertyName:e,sourceInstance:r,sourceName:s}){let t=typeof r[e]=="function";return!!s?`"${s}.${String(e)}${t?"()":""}"`:`"${String(e)}()"`}function dt(e){try{return JSON.stringify(e)}catch{return e}}var mt="ngrxOnIdentifyEffects";function pt(e){return W(e,mt)}var ht="ngrxOnRunEffects";function gt(e){return W(e,ht)}var St="ngrxOnInitEffects";function vt(e){return W(e,St)}function W(e,r){return e&&r in e&&typeof e[r]=="function"}var qe=(()=>{let r=class r extends w{constructor(t,i){super(),this.errorHandler=t,this.effectsErrorHandler=i}addEffects(t){this.next(t)}toActions(){return this.pipe(q(t=>rt(t)?Ve(t):t),V(t=>t.pipe(q(Et))),V(t=>{let i=t.pipe(ie(n=>yt(this.errorHandler,this.effectsErrorHandler)(n)),I(n=>(ft(n,this.errorHandler),n.notification)),k(n=>n.kind==="N"&&n.value!=null),re()),o=t.pipe(ee(1),k(vt),I(n=>n.ngrxOnInitEffects()));return H(i,o)}))}};r.\u0275fac=function(i){return new(i||r)(m(fe),m(nt))},r.\u0275prov=l({token:r,factory:r.\u0275fac,providedIn:"root"});let e=r;return e})();function Et(e){return pt(e)?e.ngrxOnIdentifyEffects():""}function yt(e,r){return s=>{let t=ot(s,e,r);return gt(s)?s.ngrxOnRunEffects(t):t}}var It=(()=>{let r=class r{get isStarted(){return!!this.effectsSubscription}constructor(t,i){this.effectSources=t,this.store=i,this.effectsSubscription=null}start(){this.effectsSubscription||(this.effectsSubscription=this.effectSources.toActions().subscribe(this.store))}ngOnDestroy(){this.effectsSubscription&&(this.effectsSubscription.unsubscribe(),this.effectsSubscription=null)}};r.\u0275fac=function(i){return new(i||r)(m(qe),m(A))},r.\u0275prov=l({token:r,factory:r.\u0275fac,providedIn:"root"});let e=r;return e})();function Ye(...e){let r=e.flat(),s=it(r);return ce([s,{provide:ae,multi:!0,useValue:()=>{a(ye),a(Ie,{optional:!0});let t=a(It),i=a(qe),o=!t.isStarted;o&&t.start();for(let n of r){let d=Ge(n)?a(n):n;i.addEffects(d)}o&&a(A).dispatch(ct())}}])}var ze=(()=>{let r=class r{constructor(){this.actions$=a(Je),this.authService=a(v),this.usersService=a(_),this.buildUserSession$=B(()=>this.actions$.pipe(D(Fe),J(()=>{if(this.authService.isValidToken()){let t=this.authService.getUserIdFromToken();return t?this.usersService.getUserById(t).pipe(I(i=>we({user:i})),M(()=>j(b()))):j(b())}else return j(b())}))),this.buildUserSessionFailed$=B(()=>this.actions$.pipe(D(b),Y(()=>{localStorage.removeItem("jwtToken")})),{dispatch:!1}),this.userSessionLogout$=B(()=>this.actions$.pipe(D(Ue),Y(()=>{localStorage.removeItem("jwtToken")})),{dispatch:!1})}};r.\u0275fac=function(i){return new(i||r)},r.\u0275prov=l({token:r,factory:r.\u0275fac});let e=r;return e})();function bt(e,r){e&1&&(f(0,"small"),g(1,"Email is required!"),c())}function Tt(e,r){e&1&&(f(0,"small"),g(1,"Email is not valid!"),c())}function Ft(e,r){e&1&&(f(0,"small"),g(1,"Password is required!"),c())}function wt(e,r){e&1&&(f(0,"small"),g(1,"Minimum 6 characters!"),c())}var Ut=e=>({removeHeight:e}),Ke=e=>({submitted:e}),We=(()=>{let r=class r{constructor(t,i,o,n,d,P){this.formBuilder=t,this.authService=i,this.messageService=o,this.router=n,this.utilsService=d,this.usersService=P,this.form=this.formBuilder.group({email:["",[T.required,T.email]],password:["",[T.required,T.minLength(6)]]}),this.isSubmitted=!1,this.isPasswordShown=!1,this.isUsedByNgShop=!1,this.endSubs$=new w}ngOnInit(){this._checkFromNgShop()}onSubmitLogin(){this.isSubmitted=!0,!this.form.invalid&&(this.isUsedByNgShop?this._loginNgShop():this._loginAdminPanel())}_loginAdminPanel(){this.authService.login(this.form.value).subscribe({next:t=>L(this,null,function*(){this.authService.saveTokenAdminPanel(t.token)?(this.messageService.add({severity:"success",summary:"Success",detail:"You are logged in successfully!"}),yield C(G(2e3)),this.router.navigateByUrl("/")):this.messageService.add({severity:"error",summary:"Error",detail:"You are not an admin!"})}),error:t=>{this.messageService.add({severity:"error",summary:"Error",detail:t.status!==400?"Server error, please try again later!":"Email or password incorrect"})}})}_loginNgShop(){this.authService.login(this.form.value).subscribe({next:t=>L(this,null,function*(){if(t&&t.token){this.authService.saveTokenNgShop(t.token);let i=this.authService.getUserIdFromToken();if(i){let o=this.usersService.getUserById(i),n=yield C(o);this.authService.loginNgShop(n),this.messageService.add({severity:"success",summary:"Success",detail:"You are logged in successfully!"}),yield C(G(2e3)),this.router.navigateByUrl("/")}}}),error:t=>{this.messageService.add({severity:"error",summary:"Error",detail:t.status!==400?"Server error, please try again later!":"Email or password incorrect"})}})}_checkFromNgShop(){this.utilsService.isUsedByNgShop$.pipe(se(this.endSubs$)).subscribe({next:t=>{t&&(this.isUsedByNgShop=t)},error:t=>{console.error("Cannot get UsedByNgShop",t)}})}get formControls(){return this.form.controls}ngOnDestroy(){this.endSubs$.next(null),this.endSubs$.complete()}};r.\u0275fac=function(i){return new(i||r)(E(_e),E(v),E(Be),E(S),E(Le),E(_))},r.\u0275cmp=ne({type:r,selectors:[["users-login"]],standalone:!0,features:[de],decls:30,vars:18,consts:[[1,"login-page",3,"ngClass"],[1,"login-container"],[1,"img"],["src","http://localhost:3000/public/uploads/login-register/login-register.jpg","alt","login"],[1,"red-cover"],[1,"login-inner-container"],[1,"header"],[1,"form-login",3,"formGroup","ngSubmit"],[1,"email-input"],[1,"email"],["for","email"],[1,"pi","pi-user"],["formControlName","email","type","email","name","email","id","email","placeholder","Email",3,"ngClass"],[4,"ngIf"],[1,"password-input"],[1,"password"],["for","password"],[1,"pi","pi-ellipsis-h"],["formControlName","password","name","password","id","password","placeholder","Password",3,"type","ngClass"],[1,"eye","pi",3,"title","click"],["type","submit",1,"btn-login"]],template:function(i,o){i&1&&(f(0,"section",0)(1,"div",1)(2,"div",2),y(3,"img",3)(4,"div",4),c(),f(5,"div",5)(6,"div",6)(7,"h1"),g(8,"eShop"),c(),f(9,"h2"),g(10,"Admin Panel"),c()(),f(11,"form",7),K("ngSubmit",function(){return o.onSubmitLogin()}),f(12,"div",8)(13,"div",9)(14,"label",10),y(15,"i",11),c(),y(16,"input",12),c(),z(17,bt,2,0,"small",13)(18,Tt,2,0,"small",13),c(),f(19,"div",14)(20,"div",15)(21,"label",16),y(22,"i",17),c(),y(23,"input",18),f(24,"i",19),K("click",function(){return o.isPasswordShown=!o.isPasswordShown}),c()(),z(25,Ft,2,0,"small",13)(26,wt,2,0,"small",13),c(),f(27,"button",20),g(28,"Login"),c()()()()(),y(29,"p-toast")),i&2&&(u("ngClass",N(12,Ut,o.isUsedByNgShop)),p(11),u("formGroup",o.form),p(5),u("ngClass",N(14,Ke,o.isSubmitted)),p(),u("ngIf",o.formControls.email.hasError("required")&&o.isSubmitted),p(),u("ngIf",o.formControls.email.hasError("email")&&o.isSubmitted),p(5),ue("type",o.isPasswordShown?"text":"password"),u("ngClass",N(16,Ke,o.isSubmitted)),p(),le(o.isPasswordShown?"pi-eye-slash":"pi-eye"),u("title",o.isPasswordShown?"Hide":"Show"),p(),u("ngIf",o.formControls.password.hasError("required")&&o.isSubmitted),p(),u("ngIf",o.formControls.password.hasError("minlength")&&o.isSubmitted))},dependencies:[ge,pe,he,ve,xe,Re,ke,Me,Ne,$e,Ae,Oe,Pe,De]});let e=r;return e})();var xr=[{path:"",component:We,providers:[O,Te(je,Ce),Ye([ze])]}];function Lr(){let e=a(v),r=e.getToken();if(!r)return a(S).navigateByUrl("login"),!1;try{let s=atob(r.split(".")[1]),t=JSON.parse(s);return t.isAdmin&&!e.isTokenExpried(t.exp)?!0:(a(S).navigateByUrl("login"),!1)}catch{return console.error("Error decoding JWT token"),a(S).navigateByUrl("login"),!1}}function qr(){return a(v).getToken()?(console.error("User is already logged in"),a(S).navigateByUrl("/"),!1):!0}export{v as a,Ye as b,ze as c,We as d,xr as e,Lr as f,qr as g};
